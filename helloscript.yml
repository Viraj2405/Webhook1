pipeline {
		agent any
		environment {
			SECURITY_SCAN_API = 'https://9784-45-252-74-134.ngrok-free.app/v1/startSecurityScan'
			PROJECT_ID = '7e3e0c7a-322c-4f39-988e-9f2bcb84ab10'
			BLOCK_PIPELINE = 'true'
			BLOCK_CRITICAL = 'false'
			BLOCK_HIGH = 'true'
			BLOCK_MEDIUM = 'false'
			CRITICAL_THRESHOLD = '0'
			HIGH_THRESHOLD = '2'
			MEDIUM_THRESHOLD = '0'
			INTEGRATION_ID='aa7d3cda-da67-4214-8d95-d5c349b77bd5'
		}
	
		stages {
	
			stage('Run Security Scan') {
				steps {
					script {
						def scanResponse = bat(
							script: """
								curl --location --request POST "https://9784-45-252-74-134.ngrok-free.app/v1/startSecurityScan/7e3e0c7a-322c-4f39-988e-9f2bcb84ab10" ^
								--header "Content-Type: application/json" ^
								--header "Api-Key: ${env.INTEGRATION_ID}"
							""",
							returnStdout: true
						).trim()
	
						echo "Scan Response: ${scanResponse}"
	
						if (scanResponse.contains('"message":"token expired"')) {
							error "Token expired. Exiting early."
						}
	
						def extractInt = { key ->
							def match = (scanResponse =~ /"${key}"\s*:\s*(\d+)/)
							return match ? match[0][1].toInteger() : 0
						}
	
						def critical = extractInt('criticalCount')
						def high = extractInt('highCount')
						def medium = extractInt('mediumCount')
	
						echo "Scan Summary:"
						echo "Critical: ${critical}"
						echo "High: ${high}"
						echo "Medium: ${medium}"
	
						if (env.BLOCK_PIPELINE == 'true') {
							if (env.BLOCK_CRITICAL == 'true' && critical >= env.CRITICAL_THRESHOLD.toInteger()) {
								error "Blocked due to Critical vulnerabilities exceeding threshold"
							}
							if (env.BLOCK_HIGH == 'true' && high >= env.HIGH_THRESHOLD.toInteger()) {
								error "Blocked due to High vulnerabilities exceeding threshold"
							}
							if (env.BLOCK_MEDIUM == 'true' && medium >= env.MEDIUM_THRESHOLD.toInteger()) {
								error "Blocked due to Medium vulnerabilities exceeding threshold"
							}
							echo "No blocking severity thresholds exceeded. Pipeline continued."
						} else {
							echo "Blocking disabled. Continuing pipeline regardless of severity."
						}
					}
				}
			}
	
			stage('Post-processing') {
				steps {
					echo "Post-processing steps completed."
				}
			}
		}
	
		post {
			always {
				cleanWs()
			}
		}
	}
